// ----------------------------------------
// PRISMA SCHEMA - CONTABILIDADE DUPLA
// ----------------------------------------

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ----------------------------------------
// MODELOS DE USUÁRIO E PERMISSÃO
// ----------------------------------------

model User {
  id        String      @id @default(cuid())
  name      String
  email     String      @unique
  status    StatusUsers @default(ACTIVE)
  password  String

  roleId    String
  role      Role        @relation(fields: [roleId], references: [id])

  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
}

model Resource {
  id          String        @id @default(uuid())
  name        String        @unique
  description String?
  permissions Permission[]
}

model Permission {
  id          String           @id @default(uuid())
  action      PermAction
  fields      Json?
  conditions  Json?
  resourceId  String
  resource    Resource         @relation(fields: [resourceId], references: [id])
  roles       RolePermission[]
}

model Role {
  id               String           @id @default(uuid())
  name             String           @unique
  description      String?
  isDefault        Boolean          @default(true)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime?        @updatedAt
  rolePermissions  RolePermission[]
  users            User[]
}

model RolePermission {
  id            String       @id @default(uuid())
  roleId        String
  permissionId  String
  role          Role         @relation(fields: [roleId], references: [id])
  permission    Permission   @relation(fields: [permissionId], references: [id])
}

// ----------------------------------------
// MODELO DE PARCEIRO (CLIENTE/FORNECEDOR)
// ----------------------------------------

model Partner {
  id        String   @id @default(uuid())
  name      String
  address   String
  cnpj      String   @unique
  status    Status   @default(ACTIVE)

  tittles   Tittle[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ----------------------------------------
// PLANO DE CONTAS
// ----------------------------------------

model Account {
  id                String      @id @default(uuid())
  code              String      @unique
  name              String
  description       String?
  level             Int
  acceptsPosting    Boolean     @default(false)
  active            Status      @default(ACTIVE)
  
  parentAccountId   String?
  parentAccount     Account?    @relation("ChildAccounts", fields: [parentAccountId], references: [id])
  childAccounts     Account[]   @relation("ChildAccounts")
  
  typeMovementAsCredit  typeMovement[] @relation("CreditAccount")
  typeMovementAsDebit   typeMovement[] @relation("DebitAccount")

  typeEntryAsCleared    typeEntry[]    @relation("ClearedAccount")

  journalLines          JournalLine[]

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

// ----------------------------------------
// TIPOS DE MOVIMENTO E ENTRADA
// ----------------------------------------

model typeMovement {
  id              String    @id @default(uuid())
  name            String    @unique
  description     String?

  creditAccountId String
  debitAccountId  String

  creditAccount   Account   @relation("CreditAccount", fields: [creditAccountId], references: [id])
  debitAccount    Account   @relation("DebitAccount", fields: [debitAccountId], references: [id])

  tittles         Tittle[]  

  status          Status    @default(ACTIVE)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model typeEntry {
  id              String     @id @default(uuid())
  name            String
  description     String?

  accountClearedId String
  accountCleared   Account   @relation("ClearedAccount", fields: [accountClearedId], references: [id])

  entries         Entry[]    

  status          Status     @default(ACTIVE)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
}

// ----------------------------------------
// LANÇAMENTO (TÍTULO) E ENTRADA (BAIXA)
// ----------------------------------------

model Tittle {
  id          String     @id @default(uuid())
  code        String     @unique
  description String?
  date        DateTime   @default(now())
  value       Float
  status      Status     @default(ACTIVE)

  movementId  String
  movement    typeMovement @relation(fields: [movementId], references: [id])

  partnerId   String?
  partner     Partner?     @relation(fields: [partnerId], references: [id])

  journalEntries JournalEntry[]
  entries        Entry[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model JournalEntry {
  id          String        @id @default(uuid())
  date        DateTime      @default(now())
  tittleId    String
  tittle      Tittle        @relation(fields: [tittleId], references: [id])
  lines       JournalLine[]
  createdAt   DateTime      @default(now())
}

model JournalLine {
  id             String       @id @default(uuid())
  journalEntryId String
  journalEntry   JournalEntry @relation(fields: [journalEntryId], references: [id])
  accountId      String
  account        Account      @relation(fields: [accountId], references: [id])
  type           LineType
  amount         Float
}

// ----------------------------------------
// ENTRADAS (BAIXAS DE TÍTULO)
// ----------------------------------------

model Entry {
  id           String      @id @default(uuid())
  code         String      @unique
  description  String?
  date         DateTime    @default(now())
  value        Float
  status       Status      @default(ACTIVE)

  tittleId     String
  tittle       Tittle      @relation(fields: [tittleId], references: [id])

  entryTypeId  String
  entryType    typeEntry   @relation(fields: [entryTypeId], references: [id])

  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
}

// ----------------------------------------
// ENUMS
// ----------------------------------------

enum PermAction {
  manage
  create
  read
  update
  delete
}

enum StatusUsers {
  ACTIVE
  INACTIVE
}

enum Status {
  ACTIVE
  INACTIVE
}

enum LineType {
  DEBIT
  CREDIT
}
